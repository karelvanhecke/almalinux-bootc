name: Release

on:
  push:
    tags:
      - v[0-9]+.[0-9]+.[0-9]+

jobs:
  gen-metadata:
    name: Generate metadata
    runs-on: ubuntu-24.04
    outputs:
      tags: ${{ steps.metadata.outputs.tags }}
      version: ${{ steps.metadata.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4.1.6

      - name: Validate tag version
        run: |
          #!/bin/bash
          set -xeo pipefail

          releasever=$(yq '.releasever' almalinux-bootc-version.yaml)
          if [[ ${GITHUB_REF_NAME%.*} != "v${releasever}" ]]
          then
            echo "Tag version should match major version in manifest"
            exit 1
          fi

      - name: Generate metadata
        id: metadata
        run: |
          #!/bin/bash
          set -xeo pipefail

          releasever=$(yq '.releasever' almalinux-bootc-version.yaml)
          echo "version=${GITHUB_REF_NAME#v*}" >> "$GITHUB_OUTPUT"
          echo "tags=\"${GITHUB_REF_NAME%%.*} ${GITHUB_REF_NAME%.*} ${GITHUB_REF_NAME}\"" >> "$GITHUB_OUTPUT"

  build-push:
    name: Build and push release image
    uses: ./.github/workflows/build-push.yml
    with:
      image: almalinux
      tags: ${{ needs.gen-metadata.outputs.tags }}
      version: ${{ needs.gen-metadata.outputs.version }}
    secrets: inherit
    needs: gen-metadata
    permissions:
      packages: write

  release:
    name: Create GitHub release
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4.1.6

      - name: Create Github release
        uses: softprops/action-gh-release@69320dbe05506a9a39fc8ae11030b214ec2d1f87 # v2.0.5
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref }}
          generate_release_notes: true
          draft: true
